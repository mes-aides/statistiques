{"version":3,"file":"static/webpack/static/development/pages/ab.js.aaeb268d421949a35275.hot-update.js","sources":["webpack:///./pages/ab.js"],"sourcesContent":["import {useState, useCallback, useEffect} from 'react'\nimport {categoricalColorSchemes} from '@nivo/colors'\nimport fetch from 'isomorphic-unfetch'\nimport { jStat } from 'jstat'\n//import { scaleOrdinal } from 'd3-scale'\nimport { ResponsiveBar } from '@nivo/bar'\n\nvar steps = [\n  '/foyer/demandeur',\n  '/foyer/enfants',\n  '/foyer/conjoint',\n  '/foyer/logement',\n  {\n    angularjs:'/foyer/ressources/0/types',\n    vuejs: '/foyer/demandeur/ressources/types',\n  },\n  {\n    angularjs:'/foyer/ressources/0/montants',\n    vuejs: '/foyer/demandeur/ressources/montants',\n  },\n  '/foyer/pensions-alimentaires',\n  '/foyer/resultat'\n]\n\nfunction mappy(d) {\n    return d.reduce((a, v) => {\n        a[v.label] = v\n        return a\n    }, {})\n}\n\nlet test = {\n    angularjs: 'AngularJS',\n    vuejs: 'VueJS'\n}\n\ntest = {\n    angularjs: 'period=week&date=2019-11-20',\n    vuejs: 'period=week&date=2019-12-11'\n}\n\nconst periodIndicator = [\n    'period=week&date=2019-11-22',\n    'period=day&date=yesterday',\n    'period=week&date=yesterday',\n    'period=day&date=2019-11-25',\n    'period=day&date=2019-11-27',\n    'period=day&date=2019-11-25',\n    ][4]\n\n\nfunction getDataUrl(key) {\n    return `https://stats.data.gouv.fr/index.php?${periodIndicator}&filter_limit=100&flat=1&format=JSON&idSite=9&method=Actions.getPageUrls&module=API&segment=customVariableValue2%3D%3D${key}`\n    return `https://stats.data.gouv.fr/index.php?${periodIndicator}&filter_limit=100&flat=1&format=JSON&idSite=9&method=Actions.getPageUrls&module=API&segment=customVariableValue2%3D%3D${key}`\n}\n\nfunction getDataUrlForPeriod(period) {\n    return `https://stats.data.gouv.fr/index.php?${period}&filter_limit=100&flat=1&format=JSON&idSite=9&method=Actions.getPageUrls&module=API`\n}\n\nfunction getIndicator(p1, n1, p2, n2) {\n    try {\n        return jStat.fn.oneSidedDifferenceOfProportions(\n            Math.min(1,p1), n1, Math.min(1, p2), n2\n        )\n    } catch(e) {\n        console.error(e)\n        return NaN\n    }\n}\n\nfunction ABPAge() {\n    const [values, setValues] = useState([]);\n    async function fetchData() {\n        try {\n            const resA = await fetch(getDataUrlForPeriod(test.angularjs))\n            const angularjs = mappy(await resA.json())\n            \n            const resB = await fetch(getDataUrlForPeriod(test.vuejs))\n            const vuejs = mappy(await resB.json())\n            console.log({angularjs, vuejs})\n\n            const source = {angularjs, vuejs}\n            const keys = ['angularjs', 'vuejs']\n\n            const results = steps.reduce((accum, step) => {\n                var values = keys.reduce((result, k) => {\n                    const ref = source[k][step[k] || step]\n                    const value = ref && (ref.sum_daily_nb_uniq_visitors || ref.nb_uniq_visitors) || 0\n                    result[k + '-n'] = value\n                    if (accum.previous[k] !== undefined) {\n                        result[k + '-p'] = accum.previous[k] ? Math.min(1, value / accum.previous[k]) : 0\n                        result[k + '-pr'] = Math.round(result[k + '-p'] * 1000)/10\n                        result[k + '-prc'] = Math.round(result[k + '-n'] / accum.first[k] * 1000)/10\n                    } else {\n                        accum.first[k] = value\n                    }\n                    accum.previous[k] = value\n                    return result\n                }, {})\n\n                const indicator = Math.round(getIndicator(\n                    values['vuejs-p'],\n                    values['vuejs-n'],\n                    values['angularjs-p'],\n                    values['angularjs-n'],\n                ) * 1000) / 10\n                accum.results.push({...values, indicator, step: (step.vuejs || step).slice(7)})\n\n                return accum\n            }, { results: [], previous: {}, first: {} }).results\n\n            setValues(results)\n        } catch (e) {\n            console.error(e)\n            setValues([])\n        }\n    }\n\n    useEffect(() => {\n      fetchData()\n    }, [])\n\n    const displayKeys = [\n        {\n            name: 'Conversions',\n            keys: ['angularjs-pr', 'vuejs-pr', 'angularjs-prc', 'vuejs-prc'],\n        },\n        {\n            name: 'Pertinence des Ã©cart',\n            keys: ['indicator'],\n        },\n        {\n            name: 'Nombre AngularJS',\n            keys: ['angularjs-n'],\n        },\n        {\n            name: 'Nombre VueJS',\n            keys: ['vuejs-n'],\n        }\n    ]\n\n    return (\n        <div>\n            <style jsx>{`\n                .chart {\n                    height: 300px;\n                }\n              `}</style>\n            <h1>Stats A/B</h1>\n            {displayKeys.map((d, i) => (\n                <div>\n                    <h2>{d.name}</h2>\n                    <div className=\"chart\" key={i}>\n                        <ResponsiveBar\n                            data={values}\n                            keys={d.keys}\n                            groupMode=\"grouped\"\n                            indexBy=\"step\"\n                            margin={{ top: 15, right: 10, bottom: 50, left: 60 }}\n                            padding={0.3}\n                            borderColor={{ from: 'color', modifiers: [ [ 'darker', 1.6 ] ] }}\n                            animate={false}\n                        />\n                    </div>\n                </div>\n            ))}\n            <pre>{JSON.stringify(values, null, 2)}</pre>\n        </div>\n    );\n}\n\nexport default ABPAge;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AACA;AAFA;AAKA;AACA;AAFA;AACA;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAKA;AACA;AACA;AAFA;AAKA;AACA;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAEA;AAFA;AAAA;AAAA;AACA;AADA;AAAA;AAGA;AAHA;AAAA;AACA;AADA;AAKA;AALA;AAAA;AAAA;AACA;AADA;AAAA;AAMA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAEA;AAMA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAvCA;AAAA;AACA;AADA;AAAA;AAAA;AAyCA;AACA;AACA;AA3CA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAFA;AAAA;AACA;AA+CA;AACA;AACA;AAEA;AAEA;AACA;AAFA;AAKA;AACA;AAFA;AAKA;AACA;AAFA;AAKA;AACA;AAFA;AAMA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AARA;AAAA;AAAA;AAAA;AAAA;AAAA;AAJA;AAiBA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;;;;A","sourceRoot":""}